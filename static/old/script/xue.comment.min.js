/**
 * XESUI
 * Copyright 2013 xueersi.com All rights reserved.
 *
 * @description
 *
 * @author Marco (marco@xesui.com)
 * @modify 2013-07-08 16:56:49
 * @version $Id$
 *
 * @links http://xesui.com
 */


/**
 * @name ui.comment.js
 * @description 评论相关
 *
 * @module
 * @submodule
 * @main
 * @class
 * @constructor
 * @static
 */

xue.comment = xue.comment || {};
(function() {
    var c = xue.comment;

    c.id = null;

    c.box = {
        wrap: null,
        bar: null,
        con: null,
        form: null,
        tips: null,
        btn: null,
        size: null,
        close: null,
        list: null
    };

    c.url = {
        morelink: '',
        getlist: '/Homes/dynComList',
        postcomment: '/Homes/ajaxAddDynComment'
    };

    c.url.getlist = window.location.hostname == 'v04.xesui.com' ? '../json/comments.php' : c.url.getlist;
    c.url.postcomment = window.location.hostname == 'v04.xesui.com' ? '../json/comment_post.php' : c.url.postcomment;

    c.tpl = {
        form: '<form action="javascript:void(0);" class="comment_form" data-id="$id$">' + '     <div class="comment_title">原文评论</div>' + '        <div class="comment_close"></div>' + '        <div class="comment_textarea">' + '            <textarea class="face_textarea"  data-id="$id$" size="140" name="" id="" cols="30" rows="10"></textarea>' + '        </div>' + '        <div class="comment_func">' + '            <div class="comment_kind">' + '                <ul>' + '                    <li class="kind_img">\n' + '                        <p>\n' + '                            <em class="icon_img"></em>\n' + '                        </p>\n' + '                    </li>\n' + '                    <li class="kind_media"><p class="J_smilies"><em class="icon_img"></em><span>表情</span></p></li>\n' + '                </ul>\n' + '            </div>\n' + '            <div class="comment_tips"></div>\n' + '            <div class="comment_button">\n' + '                <span class="comment_size">\n' + '                    您还可以输入<i class="text_num">140</i>字\n'
        // +'                    <i class="text_num">0</i>/140\n'
        + '                </span>\n' + '                <button data-id="$id$" class="btn btn_submit btn_sky">评论</button>\n' + '            </div>\n' + '        </div>\n' + '    </form>',

        more: '<div class="comment_more"><a href="$url$" target="_blank">更多评论</a></div>'
    };


    // 设置按钮和评论区域
    /**
     * 设置默认参数
     * @param  {[type]} expr 任意子节点
     * @return {[type]}      [description]
     */
    c.setting = function(expr) {
        var handle = $(expr);
        if (handle.length == 0) {
            return false;
        }

        var wrap = handle.parents('.feed_detail');
        if (wrap.length == 0) {
            return false;
        }

        this.id = wrap.data('id');
        this.params = wrap.data('params');
        this.box = {
            wrap: wrap,
            bar: wrap.find('.feed_btn_comment'),
            con: wrap.find('.feed_comment'),
            form: wrap.find('.comment_textarea:eq(0) textarea'),
            // text : wrap.find('.comment_textarea'),
            tips: wrap.find('.comment_tips').eq(0),
            btn: wrap.find('.comment_button:eq(0) .btn_submit'),
            size: wrap.find('.comment_size .text_num'),
            list: wrap.find('.comment_content'),
            close: wrap.find('.comment_close'),
            id : handle.data('id')
        };
        return this;
    };

    // 检测按钮和评论区域是否存在，
    // 返回按钮和评论区域节点
    c.check = function(expr) {

        if (expr) {
            this.setting(expr);
        }

        if (this.box.wrap.length == 0 || this.box.bar.length == 0 || this.box.con.length == 0) {
            return false;
        }

        return true;

    };

    c.toggle = function(expr) {
        if (expr) {
            this.setting(expr);
        } else {
            var ishandle = this.check();
            if (!ishandle) {
                return this;
            }
        }

        if (this.box.bar.hasClass('current')) {
            this.hide();
        } else {
            this.show();

            // this.box.close.click(function(){
            //     c.hide();
            // });
        }
    };

    c.show = function(expr) {
        if (expr) {
            this.setting(expr);
        } else {
            var ishandle = this.check();
            if (!ishandle) {
                return this;
            }
        }

        this.box.bar.addClass('current');
        this.box.con.removeClass('hidden');
        this.get(function(msg) {
            c.set(msg);
            // xue.log(this.box.con);
            // this.box.con.find('textarea').focus();
        });


    };

    c.hide = function(expr) {
        if (expr) {
            this.setting(expr);
        } else {
            var ishandle = this.check();
            if (!ishandle) {
                return this;
            }
        }
        var opt = this.opt;
        this.box.bar.removeClass('current');
        this.box.con.addClass('hidden');

        // 隐藏后初始化
        $.each(this.box, function(k, v) {
            c.box[k] = null;
        });
    };

    c.close = function(expr) {
        if (expr) {
            this.setting(expr);
        } else {
            var ishandle = this.check();
            if (!ishandle) {
                return this;
            }
        }
        var bar = this.box.bar;
        if (bar.data('type') && bar.data('type') == 2) {
            return;
        }
        c.hide();
    };
    // 获取评论列表
    c.get = function(expr, fn) {

        var box = null,
            callback = null;
        $.each(arguments, function() {
            if (this) {
                if (typeof this == 'function') {
                    callback = this;
                } else {
                    box = this;
                }
            }
        });
        // return;

        if (box) {
            this.setting(box);
        } else {
            var ishandle = this.check();
            if (!ishandle) {
                return this;
            }
        }
        // var opt = this.opt;

        $.ajax({
            url: c.url.getlist,
            type: 'POST',
            dataType: 'html',
            data: c.box.bar.data('params') || {
                'dynId': c.id
            },
            beforeSend: function() {
                c.box.list.html('<span class="ui_loading">Loading...</span>');
            },
            success: function(result) {
                var msg = xue.ajaxCheck.HTML(result);
                if (msg) {
                    if (typeof callback === 'function') {
                        callback(msg);
                    } else {
                        c.set(msg);
                    }
                }
            },
            error: function(a, b, c) {
                xue.alert(c);
            },
            complete: function() {
                c.box.list.find('.ui_loading').remove();
            }
        });
    };

    // 设置评论内容
    c.set = function(msg) {
        if (!msg) {
            return this;
        }
        var ishandle = this.check();
        if (!ishandle) {
            return this;
        }

        var wrap = this.box.list;
        wrap.html(msg);

        // 评论发布框
        var form = this.tpl.form;
        form = form.replace(/\$id\$/g, this.id);
        if(this.box.con.find('.comment_form').length === 0){
        // if (this.box.form.length == 0) {
            wrap.before(form);
        }
        // xue.log(this.box.con);
        this.box.con.find('.comment_textarea:eq(0) textarea').focus();
        c.box.close = c.box.wrap.find('.comment_close');
        if (c.box.bar.data('type') && c.box.bar.data('type') == 2) {
            c.box.close.hide();
        } else {
            c.box.close.show();
        }
    };
    c.del = function() {

    };

    // 发布评论
    c.post = function(expr) {

        if (expr) {
            this.setting(expr);
        } else {
            return this;
        }

        var that = $(expr);
        if (that.length == 0) {
            return;
        }

        var content = $.trim(this.box.form.val());
        var len = content.length;
        if (len == 0) {
            this.box.tips.text('请您填写内容');
        } else if (len > 140) {
            this.box.tips.text('请不要超过140个字');
            // if(len < 10 || len > 140 || len == 0){
            // this.box.tips.text('请填写内容，长度在10~140之间');
        } else {
            this.box.tips.empty();
        }

        var vd = $('#verificationCode').val();
        var _show = $('#tips_verificationCode');
        var _form = c.box.con;

        // var data = 
        var param = this.box.bar.data('params') || {
            'dynId': c.id,
            'content': content,
            'verificationCode': vd
        };

        if (this.box.tips.text() == '') {
            $.ajax({
                url: c.url.postcomment,
                data: param + '&content=' + encodeURIComponent(content) + '&verificationCode=' + vd,
                type: 'POST',
                dataType: 'json',
                beforeSend: function() {
                    c.box.form.before('<div class="comment_status"><span class="ui_loading">Loading...</span></div>');
                    c.box.btn.before('<div class="ui_disible_div"></div>');
                    $('.comments_medal_button button').addClass('btn_visible');
                },
                success: function(result) {
                    // var msg = xue.ajaxCheck.JSON(result);
                    var tp = result.sign,
                        msg = result.msg;
                    if (tp === 0) {
                        alert(msg);
                        c.box.form.val('');
                        return false;
                    }
                    if (tp === 2) {
                        window.location.href = result.msg;
                    }
                    if (tp === 1) {
                        xue.win('winCode').close();
                        c.box.form.val('');
                        c.box.con.find('.comment_status').html('<p class="ui_success">发布成功</p>');
                        c.get();
                        c.setcount();
                        c.box.size.text(140);
                        
                    }
                     if (tp === 3) {
                       _show.text(msg);
                       $('#verificationCode').focus();
                       $('.comments_medal_button button').removeClass('btn_visible');
                       return false;
                    }
                },
                error: function(a, b, c) {
                    _form.find('.comment_status').html('<p class="ui_warning">' + c + '</p>');
                },
                complete: function() {
                    setTimeout(function() {
                        c.box.con.find('.comment_status').fadeOut('fast', function() {
                            $(this).remove();
                        });
                        c.box.con.find('.ui_disible_div').remove();
                        $('#verificationCode').focus();
                       // c.box.form.focus();
                    }, 1000);
                }
            });
        }
    };

    c.countsize = function(expr) {
        var that = $(expr);
        if (that.length == 0) {
            return;
        }
        var val = $.trim(that.val());
        var len = val.length;
        var wrap = that.parents('.comment_form'),
            size = wrap.find('.comment_size .text_num');

        if (len > 140) {
            that.val(val.substring(0, 140));
            size.text(0);
            return false;
        } else {
            size.text(140 - len);
        }
    };

    // 设置评论数
    c.setcount = function() {
        var ishandle = this.check();
        if (!ishandle) {
            return this;
        }
        // 匹配括号内容
        var re = /\(([^\(]*)\)/;

        var countbox = this.box.bar.parents('.ui_feed').find('.comments-num');
        // console.log(countbox.html())
        if (countbox.length == 0) {
            return false;
        }
        //获取原来的内容
        var oldtext = countbox.html();

        // 获取括号内的数字，进行累加
        var text = oldtext.match(re);
        var num = Number(text[1]);
        num++;

        // 替换原来括号中的数字为累加后的数字
        // var newtext = oldtext.replace(re,'(' + num + ')');

        // 设置新内容
        countbox.html('(' + num + ')');
    };

    // 评论列表里回复区域切换
    c.replyToggle = function(expr) {

        if (expr) {
            this.setting(expr);
        } else {
            return this;
        }
         var _id = $(this.box.con[0]).find('.comment_form').data('id');
         var tpl = '<div class="mention_comment">' + '   <div class="comment_textarea mention_textarea">' + '            <textarea class="face_textarea" rows="10" cols="30" id="" name="" size="140" data-id="'+_id+'"> // $quote$</textarea>' + '        </div>' + '        <div class="comment_func mention_func">' + '            <div class="comment_kind">' + '                <ul>' + '                    <li class="kind_img">\n' + '                        <p>\n' + '                            <em class="icon_img"></em>\n' + '                        </p>\n' + '                    </li>\n' + '                    <li class="kind_media"><p class="J_smilies"><em class="icon_img"></em><span>表情</span></p></li>\n' + '                </ul>\n' + '            </div>\n' + '            <div class="comment_tips"></div>' + '            <div class="comment_button">' + '                <button class="btn btn_submit btn_sky" data-id="'+_id+'">评论</button>' + '            </div>' + '        </div>' + '    </div>';

        var wrap = $(this.box.wrap[0]),
            user = wrap.find('.feed_user'),
            text = wrap.find('.feed_content'),
            bar = $(expr).parents('.feed_bar');

       // var _text = text.html().toLowerCase().replace(/<img.*? src="(.*?)" title="(.*?)".*?>/g,function(a1, a2, a3){
       //    var src = a2;
       //    var tit = a3;
       //    if(src.indexOf('http://img04.xesimg.com/icon/emoji') > -1){
       //      return '[' + tit + ']';
       //    }else{
       //      return a1;
       //    }
       //  });
       
        // 将HTML大写标签转换为小写
        var _text = text.html().replace(/<[^>].*?>/g,function(a1){
            var dom = a1.toLowerCase();
            return dom;
        });
        // 查找img标签，替换为img的title
       _text = _text.replace(/<img.*?>/g,function(a1){
            var img = $(a1),
                tit = img.attr('title');
            if(img.attr('src').indexOf('http://img04.xesimg.com/icon/emoji') > -1){
                return '[' + tit + ']';
            }else{
                return a1;
            }
       });
       // 再去掉内容中的所有标签
        _text = _text.replace(/<[^>].*?>/g,'');
 
        tpl = tpl.replace('$quote$', '@' + user.data('user') + ' ' + _text);
        if (bar.length == 0) {
            return false;
        }
        bar = bar.length > 1 ? $(bar[0]) : bar;
        var mention = bar.next('.mention_comment');
        if (mention.length == 0) {
            bar.after(tpl);
            bar.next().find('.comment_textarea textarea').focus();
        } else {
            mention.remove();
        }

    };
    // @中的回复
    c.reply = function(expr) {

        if (expr) {
            this.setting(expr);
        } else {
            return this;
        }

        var that = $(expr);
        if (that.length == 0) {
            return;
        }

        var wrap = $(this.box.wrap[0]),
            textarea = wrap.find('textarea'),
            content = $.trim(textarea.val()),
            tips = wrap.find('.mention_func').find('.comment_tips'),
            _form = wrap.find('.mention_comment');
        var vd = $('#verificationCode').val();
        var _show = $('#tips_verificationCode');
        var len = content.length;
        if (len == 0) {
            tips.text('请您填写内容');
        } else if (len > 140) {
            tips.text('请不要超过140个字');
            // if(len < 10 || len > 140 || len == 0){
            // this.box.tips.text('请填写内容，长度在10~140之间');
        } else {
            tips.empty();
        }
        // var _form = c.box.con;
        // xue.log(this.box.bar);
        // var data = 
        var param = this.box.bar.data('params') || {
            'dynId': c.id,
            'content': content,
            'verificationCode': vd
        };

        if (tips.text() == '') {
            $.ajax({
                url: c.url.postcomment,
                data: param + '&content=' + encodeURIComponent(content)  + '&verificationCode=' + vd,
                type: 'POST',
                dataType: 'json',
                beforeSend: function() {
                    if (textarea.prev('.comment_status').length == 0) {
                        textarea.before('<div class="comment_status"><span class="ui_loading">Loading...</span></div>');
                    }
                    if (that.prev('.ui_disible_div').length == 0) {
                        that.before('<div class="ui_disible_div"></div>');
                    }
                    $('.comments_medal_button button').addClass('btn_visible');
                },
                success: function(result) {
                    var msg = xue.ajaxCheck.JSON(result);
                    var tp = result.sign,
                        msg = result.msg;
                    // if (msg) {
                    //     xue.win('winCode').close();
                    //     textarea.val('');
                    //     _form.find('.comment_status').html('<p class="ui_success">发布成功</p>');
                    //     c.get();
                    //     // c.setcount();
                    //     // c.box.size.text(140);
                    // }
                    if (tp === 0) {
                        //alert(msg);
                        c.box.form.val('');
                        return false;
                    }
                    if (tp === 2) {
                        window.location.href = result.msg;
                    }
                    if (tp === 1) {
                        xue.win('winCode').close();
                        textarea.val('');
                        _form.find('.comment_status').html('<p class="ui_success">发布成功</p>');
                        c.setcount();
                        c.get();
                        c.box.size.text(140);
                    }
                    if (tp === 3) {
                       _show.text(msg);
                       $('#verificationCode').focus();
                       $('.comments_medal_button button').removeClass('btn_visible');
                       return false;
                    }
                },
                error: function(a, b, c) {
                    _form.find('.comment_status').html('<p class="ui_warning">' + c + '</p>');
                },
                complete: function() {
                    setTimeout(function() {
                        _form.find('.comment_status').fadeOut('fast', function() {
                            $(this).remove();
                        });
                        _form.find('.ui_disible_div').remove();
                        $('#verificationCode').focus();
                        //textarea.focus();
                    }, 1000);
                }
            });
        }
    }

})();