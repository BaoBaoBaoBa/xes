/**
 * XESUI 
 * Copyright 2013 xueersi.com All rights reserved.
 *
 * @description 
 *
 * @author Marco (marco@xesui.com)
 * @modify 2013-07-08 16:48:18
 * @version $Id$
 * 
 * @links http://xesui.com
 */


/**
 * @name ui.courses.js
 * @description 这里是课程列表的全部交互效果
 * 
 * @module 
 * @submodule 
 * @main 
 * @class 
 * @constructor 
 * @static 
 */

xue.course = xue.course || {};

(function(){
    var c = xue.course;
    
    var now_wheel = null;

    c.outline = c.outline || function( a ){
        var D = this, timer, wrap = $('#' + a);
        if( wrap.length == 0 ){ return; }

        this.box = wrap.find('.scrolls_con');
        this.con = this.box.find('ul');
        this.bar = wrap.find('.scrolls_bar');
        this.btn = this.bar.find('.scrolls');

        this.countbar = function(){
            var btn = this.btn.height(), bar = this.bar.height(), 
                box = this.box.height(), con = this.con.height();

            btn = Math.round((box * bar) / con);
            this.btn.height(btn);


        };
        // 计算滚动条高度，可选
        this.countbar();
        // console.log('btn : ' + this.btn.height());
        // console.log('bar : ' + this.bar.height());
        if(this.btn.height() >= this.bar.height()){ 
            this.btn.hide();
            return; 
        }

        this.clearselect = window.getSelection ? function() {
            window.getSelection().removeAllRanges();
        } : function() {
            document.selection.empty();
        };

        this.is_bottom = function() { // 检测是不是位于底部了
            if (D.con.position().top <= D.box.height() - D.con.height()) {
                return true;
            }
            return false;
        }
        this.resetright = function() {
            var a = D.con.position().top / (D.con.height() - D.box.height());
            var b = D.bar.height() - D.btn.height();
            var c = (0 - b * a);
            D.btn.css('top', c);
        }
        this.resetleft = function() {
            var a = (D.btn.position().top) / (D.bar.height() - D.btn.height());
            var b = D.con.height() - D.box.height();
            var c = 0 - (b * a);
            D.con.css('top', c);
        }
        this.move = function(a) {
            if (D.con.position().top + a <= 0 && D.con.position().top + a >= D.box.height() - D.con.height()) {
                D.con.css('top', (D.con.position().top + a));
            } else if (D.con.position().top + a > 0) {
                D.con.css('top', 0);
            } else if (D.con.position().top + a < D.box.height() - D.con.height()) {
                D.con.css('top', D.box.height() - D.con.height());
            }
            D.resetright();
        }
        this.upper = function() {
            D.clear();
            timer = window.setInterval(function() {
                D.move(2);
            }, 5);
        }
        this.downer = function() {
            D.clear();
            timer = window.setInterval(function() {
                D.move(-2);
            }, 5);
        }
        this.clear = function() {
            window.clearInterval(timer);
        }
        this.test_bar = function() {
            if (D.box.height() < D.con.height()) {
                D.bar.show();
            } else {
                D.bar.hide();
            }
        }
        this.gotobottom = function() {
            var a = (D.con.height() > D.box.height()) ? D.box.height() - D.con.height() : 0;
            D.con.css('top', a);
            D.test_bar();
            D.resetright();
        }
        this.wheel = function() {
            if (now_wheel == null) now_wheel = a;
            if (now_wheel == a) {
                var e = arguments[0] || window.event;
                
                //增大分母的数字，可以使滚动速度变慢，默认是：e.wheelDelta / 120 和 e.detail / 3
                var act = e.wheelDelta ? e.wheelDelta / 360 : (0 - e.detail / 10);
                D.clear();
                D.move(80 * act);
                try {
                    e.preventDefault();
                } catch (e) {}
            }
            window.setTimeout(function() {
                D.end_wheel();
            }, 1);
            return false;
        }
        this.end_wheel = function() {
            now_wheel = null;
        }
        this.barmove = function() {
            // 记录当时鼠标的位置与
            D.clearselect;
            var mover = this;
            this.can_move_top = D.btn.position().top; // 这个滚动条上方的可移动距离
            this.can_move_bottom = D.bar.height() - D.btn.position().top - D.btn.height(); // 这个滚动条下方的可移动距离
            this.e = arguments[0] || window.event;
            this.starts = this.e.clientY;
            this.starttop = D.btn.position().top;
            this.drag = function() {
                this.e = arguments[0] || window.event;
                this.ends = this.e.clientY;
                this.dis = this.ends - mover.starts;
                if (this.dis < (0 - mover.can_move_top)) this.dis = 0 - mover.can_move_top;
                if (this.dis > mover.can_move_bottom) this.dis = mover.can_move_bottom;
                D.btn.css('top', mover.starttop + this.dis);
                D.resetleft();
                D.clearselect;
            }
            this.cleardrag = function() {
                if (window.removeEventListener) {
                    document.removeEventListener("mousemove", mover.drag, true);
                } else {
                    document.detachEvent("onmousemove", mover.drag);
                }
                D.clearselect;
            }
            this.add_listener = function() {
                if (window.addEventListener) {
                    document.addEventListener("mousemove", mover.drag, true);
                    document.addEventListener("mouseup", mover.cleardrag, true);
                } else {
                    document.attachEvent("onmousemove", mover.drag);
                    document.attachEvent("onmouseup", mover.cleardrag);
                }
            }
            this.add_listener();
        }
        this.outbar = function() {
            var e = arguments[0] || window.event;
            var obj = e.srcElement ? e.srcElement : e.target;
            // if (obj.id == D.bar.attr('id')) {
            if (obj == D.bar[0]) {
                var y = e.offsetY || e.layerY;
                var new_top = y - 0.5 * D.btn.height();
                // 防止new_top为负值
                new_top = new_top < 0 ? 0 : new_top;
                if (D.bar.height() - y < 0.5 * D.btn.height()) new_top = D.bar.height() - D.btn.height();
                D.btn.css('top', new_top);

                D.resetleft();
            }
        }
        this.btn.ondrag = function() { return false; }
        this.btn.oncontextmenu = function() { return false; }
        this.btn.onselectstart = function() { return false; }

        if (window.addEventListener) {
            this.btn[0].addEventListener("mousedown", this.barmove, false);
            this.bar[0].addEventListener("mousedown", this.outbar, false);
            this.box[0].parentNode.addEventListener("DOMMouseScroll", this.wheel, false);
            this.box[0].parentNode.addEventListener("mousewheel", this.wheel, false);
            document.addEventListener("mouseup", this.clear, false);
        } else {
            this.btn[0].attachEvent("onmousedown", this.barmove);
            this.bar[0].attachEvent("onmousedown", this.outbar);
            this.box[0].parentNode.attachEvent("onmousewheel", this.wheel);
            document.attachEvent("onmouseup", this.clear);
            try {
                window.event.cancelBubble = true;
            } catch (e) {}
        }

        this.setCurrentTop = function(){
            var contop = this.con.find('li.current').position().top;
            this.box.css('top', -contop);
            this.resetright();
            this.resetleft();
        };
    };


})();



// var now_wheel = null;
// var scroller = function(a) {
//     var D = this, timer, wrap = $('#' + a);
//     if( wrap.length == 0 ){ return; }

//     this.box = wrap.find('.scrolls_con');
//     this.con = this.box.find('ul');
//     this.bar = wrap.find('.scrolls_bar');
//     this.btn = this.bar.find('.scrolls');

//     this.clearselect = window.getSelection ? function() {
//         window.getSelection().removeAllRanges();
//     } : function() {
//         document.selection.empty();
//     };
//     this.is_bottom = function() { // 检测是不是位于底部了
//         if (D.con.position().top <= D.box.height() - D.con.height()) {
//             return true;
//         }
//         return false;
//     }
//     this.resetright = function() {
//         var a = D.con.position().top / (D.con.height() - D.box.height());
//         var b = D.bar.height() - D.btn.height();
//         var c = (0 - b * a);
//         D.btn.css('top', c);
//     }
//     this.resetleft = function() {
//         var a = (D.btn.position().top) / (D.bar.height() - D.btn.height());
//         var b = D.con.height() - D.box.height();
//         var c = 0 - (b * a);
//         D.con.css('top', c);
//     }
//     this.move = function(a) {
//         if (D.con.position().top + a <= 0 && D.con.position().top + a >= D.box.height() - D.con.height()) {
//             D.con.css('top', (D.con.position().top + a));
//         } else if (D.con.position().top + a > 0) {
//             D.con.css('top', 0);
//         } else if (D.con.position().top + a < D.box.height() - D.con.height()) {
//             D.con.css('top', D.box.height() - D.con.height());
//         }
//         D.resetright();
//     }
//     this.upper = function() {
//         D.clear();
//         timer = window.setInterval(function() {
//             D.move(2);
//         }, 5);
//     }
//     this.downer = function() {
//         D.clear();
//         timer = window.setInterval(function() {
//             D.move(-2);
//         }, 5);
//     }
//     this.clear = function() {
//         window.clearInterval(timer);
//     }
//     this.test_bar = function() {
//         if (D.box.height() < D.con.height()) {
//             D.bar.show();
//         } else {
//             D.bar.hide();
//         }
//     }
//     this.gotobottom = function() {
//         var a = (D.con.height() > D.box.height()) ? D.box.height() - D.con.height() : 0;
//         D.con.css('top', a);
//         D.test_bar();
//         D.resetright();
//     }
//     this.wheel = function() {
//         if (now_wheel == null) now_wheel = a;
//         if (now_wheel == a) {
//             var e = arguments[0] || window.event;
//             var act = e.wheelDelta ? e.wheelDelta / 120 : (0 - e.detail / 3);
//             D.clear();
//             D.move(80 * act);
//             try {
//                 e.preventDefault();
//             } catch (e) {}
//         }
//         window.setTimeout(function() {
//             D.end_wheel();
//         }, 1);
//         return false;
//     }
//     this.end_wheel = function() {
//         now_wheel = null;
//     }
//     this.barmove = function() {
//         // 记录当时鼠标的位置与
//         D.clearselect;
//         var mover = this;
//         this.can_move_top = D.btn.position().top; // 这个滚动条上方的可移动距离
//         this.can_move_bottom = D.bar.height() - D.btn.position().top - D.btn.height(); // 这个滚动条下方的可移动距离
//         this.e = arguments[0] || window.event;
//         this.starts = this.e.clientY;
//         this.starttop = D.btn.position().top;
//         this.drag = function() {
//             this.e = arguments[0] || window.event;
//             this.ends = this.e.clientY;
//             this.dis = this.ends - mover.starts;
//             if (this.dis < (0 - mover.can_move_top)) this.dis = 0 - mover.can_move_top;
//             if (this.dis > mover.can_move_bottom) this.dis = mover.can_move_bottom;
//             D.btn.css('top', mover.starttop + this.dis);
//             D.resetleft();
//             D.clearselect;
//         }
//         this.cleardrag = function() {
//             if (window.removeEventListener) {
//                 document.removeEventListener("mousemove", mover.drag, true);
//             } else {
//                 document.detachEvent("onmousemove", mover.drag);
//             }
//             D.clearselect;
//         }
//         this.add_listener = function() {
//             if (window.addEventListener) {
//                 document.addEventListener("mousemove", mover.drag, true);
//                 document.addEventListener("mouseup", mover.cleardrag, true);
//             } else {
//                 document.attachEvent("onmousemove", mover.drag);
//                 document.attachEvent("onmouseup", mover.cleardrag);
//             }
//         }
//         this.add_listener();
//     }
//     this.outbar = function() {
//         var e = arguments[0] || window.event;
//         var obj = e.srcElement ? e.srcElement : e.target;
//         if (obj.id == D.bar.attr('id')) {

//             var y = e.offsetY || e.layerY;
//             var new_top = y - 0.5 * D.btn.height();
//             if (D.bar.height() - y < 0.5 * D.btn.height()) new_top = D.bar.height() - D.btn.height();
//             D.btn.css('top', new_top);
//             D.resetleft();
//         }
//     }
//     this.btn.ondrag = function() { return false; }
//     this.btn.oncontextmenu = function() { return false; }
//     this.btn.onselectstart = function() { return false; }

//     if (window.addEventListener) {
//         this.btn[0].addEventListener("mousedown", this.barmove, false);
//         this.bar[0].addEventListener("mousedown", this.outbar, false);
//         this.box[0].parentNode.addEventListener("DOMMouseScroll", this.wheel, false);
//         this.box[0].parentNode.addEventListener("mousewheel", this.wheel, false);
//         document.addEventListener("mouseup", this.clear, false);
//     } else {
//         this.btn[0].attachEvent("onmousedown", this.barmove);
//         this.bar[0].attachEvent("onmousedown", this.outbar);
//         this.box[0].parentNode.attachEvent("onmousewheel", this.wheel);
//         document.attachEvent("onmouseup", this.clear);
//         try {
//             window.event.cancelBubble = true;
//         } catch (e) {}
//     }
// }



// var now_wheel = null;
// var scroller = function(a){
//     var self = this;
//     var timer;
//     this.container = document.getElementById(a+"_container"); // 容器
//     this.shower = document.getElementById(a+"_shower"); // 显示的内容
//     this.scroller = document.getElementById(a+"_scroller"); // 滚动条容器
//     this.scroll_up = document.getElementById(a+"_scroll_up"); // 上翻按钮
//     this.scroll_down = document.getElementById(a+"_scroll_down"); // 下翻按钮
//     this.scroll_bar = document.getElementById(a+"_scroll_bar"); // 滑动块
//     this.clearselect = window.getSelection ? function(){ window.getSelection().removeAllRanges(); } : function(){ document.selection.empty(); };
//     this.is_bottom = function(){ // 检测是不是位于底部了
//         if (self.shower.offsetTop <= self.container.offsetHeight-self.shower.offsetHeight){
//             return true;
//         }
//         return false;
//     }
//     this.resetright = function(){
//         var a = self.shower.offsetTop / (self.shower.offsetHeight - self.container.offsetHeight);
//         var b = self.scroller.offsetHeight - self.scroll_down.offsetHeight - self.scroll_bar.offsetHeight - self.scroll_up.offsetHeight;
//         var c = self.scroll_up.offsetHeight + (0 - b * a);
//         self.scroll_bar.style.top = c + "px";
//     }
//     this.resetleft = function(){
//         var a = (self.scroll_bar.offsetTop - self.scroll_up.offsetHeight) / (self.scroller.offsetHeight - self.scroll_up.offsetHeight - self.scroll_down.offsetHeight - self.scroll_bar.offsetHeight);
//         var b = self.shower.offsetHeight - self.container.offsetHeight;
//         var c = 0 - (b * a);
//         self.shower.style.top = c + "px";
//     }
//     this.move=function(a){
//         if (self.shower.offsetTop+a <= 0 && self.shower.offsetTop+a >= self.container.offsetHeight-self.shower.offsetHeight){
//             self.shower.style.top = (self.shower.offsetTop+a)+"px";
//         }else if (self.shower.offsetTop+a > 0){
//             self.shower.style.top = 0+"px";
//         }else if (self.shower.offsetTop+a < self.container.offsetHeight-self.shower.offsetHeight){
//             self.shower.style.top = self.container.offsetHeight-self.shower.offsetHeight+"px";
//         }
//         self.resetright();
//     }
//     this.upper = function(){
//         self.clear();
//         timer = window.setInterval(function(){self.move(2);}, 5);
//     }
//     this.downer = function(){
//         self.clear();
//         timer = window.setInterval(function(){self.move(-2);}, 5);
//     }
//     this.clear = function(){
//         window.clearInterval(timer);
//     }
//     this.test_bar = function(){
//         if (self.container.offsetHeight < self.shower.offsetHeight){
//             self.scroller.style.display = "block";
//         }else {
//             self.scroller.style.display = "none";
//         }
//     }
//     this.gotobottom = function(){
//         var a = (self.shower.offsetHeight > self.container.offsetHeight) ? self.container.offsetHeight - self.shower.offsetHeight : 0;
//         self.shower.style.top = a + "px";
//         self.test_bar();
//         self.resetright();
//     }
//     this.wheel = function(){
//         if (now_wheel == null) now_wheel =a;
//         if (now_wheel == a){
//             var e=arguments[0]||window.event;
//             var act = e.wheelDelta ? e.wheelDelta/120 : (0 -e.detail/3);
//             self.clear();
//             self.move(80*act);
//             try{ e.preventDefault();}
//             catch(e){}
//         }
//         window.setTimeout(function(){self.end_wheel();}, 1);
//         return false;
//     }
//     this.end_wheel = function(){
//         now_wheel = null;
//     }
//     this.barmove = function(){
//         // 记录当时鼠标的位置与
//         self.clearselect;
//         var mover = this;
//         this.can_move_top = self.scroll_bar.offsetTop - self.scroll_up.offsetHeight; // 这个滚动条上方的可移动距离
//         this.can_move_bottom = self.scroller.offsetHeight - self.scroll_bar.offsetTop - self.scroll_down.offsetHeight - self.scroll_bar.offsetHeight; // 这个滚动条下方的可移动距离
//         this.e=arguments[0]||window.event;
//         this.starts = this.e.clientY;
//         this.starttop = self.scroll_bar.offsetTop;
//         this.drag = function(){
//             this.e=arguments[0]||window.event;
//             this.ends = this.e.clientY;
//             this.dis = this.ends - mover.starts;
//             if (this.dis < (0-mover.can_move_top)) this.dis = 0-mover.can_move_top;
//             if (this.dis > mover.can_move_bottom) this.dis = mover.can_move_bottom;
//             self.scroll_bar.style.top = (mover.starttop + this.dis) + "px";
//             self.resetleft();
//             self.clearselect;
//         }
//         this.cleardrag = function(){
//             if (window.removeEventListener){
//                 document.removeEventListener("mousemove", mover.drag, true);
//             }else {
//                 document.detachEvent("onmousemove", mover.drag);
//             }
//             self.clearselect;
//         }
//         this.add_listener = function(){
//             if (window.addEventListener){
//                 document.addEventListener("mousemove", mover.drag, true);
//                 document.addEventListener("mouseup", mover.cleardrag, true);
//             }else {
//                 document.attachEvent("onmousemove", mover.drag);
//                 document.attachEvent("onmouseup", mover.cleardrag);
//             }
//         }
//         this.add_listener();
//     }
//     this.outbar = function(){
//         var e=arguments[0]||window.event;
//         var obj = e.srcElement ? e.srcElement : e.target;
//         if (obj.id == self.scroller.id){
//             var y = e.offsetY || e.layerY;
//             var new_top = y - 0.5 * self.scroll_bar.offsetHeight;
//             if (y - self.scroll_up.offsetHeight < 0.5 * self.scroll_bar.offsetHeight) new_top = self.scroll_up.offsetHeight;
//             if (self.scroller.offsetHeight - y - self.scroll_down.offsetHeight < 0.5 * self.scroll_bar.offsetHeight) new_top = self.scroller.offsetHeight - self.scroll_down.offsetHeight - self.scroll_bar.offsetHeight;
//             self.scroll_bar.style.top = new_top + "px";
//             self.resetleft();
//         }
//     }
//     this.scroll_bar.ondrag=function(){return false;}
//     this.scroll_bar.oncontextmenu=function(){return false;} 
//     this.scroll_bar.onselectstart=function(){return false;}
//     if (window.addEventListener){
//         this.scroll_up.addEventListener("mousedown", this.upper, false);
//         this.scroll_down.addEventListener("mousedown", this.downer, false);
//         this.scroll_bar.addEventListener("mousedown", this.barmove, false);
//         this.scroller.addEventListener("mousedown", this.outbar, false);
//         this.container.parentNode.addEventListener("DOMMouseScroll", this.wheel, false);
//         this.container.parentNode.addEventListener("mousewheel", this.wheel, false);
//         document.addEventListener("mouseup", this.clear, false);
//     }else {
//         this.scroll_up.attachEvent("onmousedown", this.upper);
//         this.scroll_down.attachEvent("onmousedown", this.downer);
//         this.scroll_bar.attachEvent("onmousedown", this.barmove);
//         this.scroller.attachEvent("onmousedown", this.outbar);
//         this.container.parentNode.attachEvent("onmousewheel", this.wheel);
//         document.attachEvent("onmouseup", this.clear);
//         try{ window.event.cancelBubble=true;}
//         catch(e){}
//     }
// }








// function scroll(id,id2){
//     var obj=document.getElementById(id);
//     var list=document.getElementById(id2);
//     list.scrollTop=0;
//     var oUl=list.children[0];
//     var bar=obj.getElementsByTagName("div")[0];
//     var prev=obj.getElementsByTagName("div")[1];
//     var next=obj.getElementsByTagName("div")[2];
//     if(oUl.offsetHeight>list.offsetHeight){
//         obj.style.display='block';
//         list.style.overflowY='scroll';
//         //按比例设置滚动条长度
//         bar.style.height=Math.floor(obj.offsetHeight*list.offsetHeight/oUl.offsetHeight)+'px';
//         bar.style.overflow='hidden';
//         //拖拽滚动条事件加载
//         bar.onmousedown=function(ev){
//             var o=this;
//             var oEvent=ev||event;
//             var y=oEvent.clientY-this.offsetTop;
//             document.onmousemove=function(ev){
//                 oEvent=ev||event;
//                 var otop=oEvent.clientY-y;
//                 var stop=otop*oUl.offsetHeight/obj.offsetHeight;
//                 if(otop<=0){
//                     o.style.top=0+'px';
//                     list.scrollTop=0;
//                 }else if(otop>=obj.offsetHeight-bar.offsetHeight){
//                     o.style.top=obj.offsetHeight-bar.offsetHeight+'px';
//                     list.scrollTop=oUl.offsetHeight-list.offsetHeight;
//                 }else{
//                     o.style.top=otop+'px';
//                     list.scrollTop=stop;
//                 }
//             }
//             document.onmouseup=function(){
//                 document.onmousemove=null;
//                 document.onmouseup=null;
//             }
//         }
//         //向上按钮事件加载
//         prev.onmousedown=function(){
//             if(bar.offsetTop>0){
//                 var move=setInterval(function(){
//                     if(bar.offsetTop-obj.offsetHeight*0.02>0){
//                         bar.style.top=bar.offsetTop-obj.offsetHeight*0.02+'px';
//                         list.scrollTop=list.scrollTop-oUl.offsetHeight*0.02;
//                     }else{
//                         clearInterval(move);
//                         bar.style.top=0+'px';
//                         list.scrollTop=0;
//                     }
//                 },100);
//                 prev.onmouseup=function(){clearInterval(move);}
//             }
//         }
//         //向下按钮事件加载
//         next.onmousedown=function(){
//             if(bar.offsetTop<obj.offsetHeight-bar.offsetHeight){
//                 var move=setInterval(function(){
//                     if(bar.offsetTop+obj.offsetHeight*0.02<obj.offsetHeight-bar.offsetHeight){
//                         bar.style.top=bar.offsetTop+obj.offsetHeight*0.02+'px';
//                         list.scrollTop=list.scrollTop+oUl.offsetHeight*0.02;
//                     }else{
//                         clearInterval(move);
//                         bar.style.top=obj.offsetHeight-bar.offsetHeight+'px';
//                         list.scrollTop=oUl.offsetHeight-list.offsetHeight;
//                     }
//                 },100);
//                 next.onmouseup=function(){clearInterval(move);}
//             }
//         }
//         //鼠标滚轮事件加载
//         list.onscroll=function(){
//             bar.style.top=list.scrollTop*obj.offsetHeight/oUl.offsetHeight+'px';
//         }
//     }
// }