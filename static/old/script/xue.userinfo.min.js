/**
 * XESUI 
 * Copyright 2013 xueersi.com All rights reserved.
 *
 * @description 
 *
 * @author Marco (marco@xesui.com)
 * @modify 2013-07-08 16:57:28
 * @version $Id$
 * 
 * @links http://xesui.com
 */


/**
 * @name ui.userinfo.js
 * @description 弹出的用户信息窗口
 * 
 * @module 
 * @submodule 
 * @main 
 * @class 
 * @constructor 
 * @static 
 */

xue.userinfo = xue.userinfo || {};
(function(){
    var u = xue.userinfo;
    // u.queue = 
    u.opt = {
        id : null,
        handle : null,
        orientation : null,
        content : null
    };

    u.show = function( expr, content ){
        if(arguments.length == 0){ return; }


        var msg = content || null, handle = expr ? $(expr) : false;
        
        var left, top, tp;
        if(handle.length == 0 && !msg){ return; }

        // u.setDom(handle, msg);



        var w = handle.width(), h = handle.height(),
            l = handle.offset().left, t = handle.offset().top;
        
        // win (w:330 h:150)
        
        var left = l - 50,
            top  = t - 150,
            arrow = 'bl';

        var side = handle.parents('.layout_side').hasClass('right');

        if(side){
            left = l - 235;
            arrow = 'br';
        }

        var o = {
            id      : 'userinfo',
            cls     : 'dialog_userinfo',
            title   : false,
            submit  : false,
            cancel  : false,
            lock    : false,
            close   : false,
            left    : left,
            top     : top,
            handle  : handle,
            arrow   : arrow,
            content : '<div class="pop_userinfo_wrap">' + msg + '</div>'
        };

        xue.win(o);




        // 根据滚动条设置显示的方向，以及箭头位置
        // var win = xue.win('userinfo');
        // var s = win.getSize();
        // var new_top = t - (s.height) - 8;
        // if((new_top - $(window).scrollTop()) < 0){
        //     new_top = t + h + 5;
        //     var _uwin = $('.dialog_userinfo');
        //     var _arrow = _uwin.find('.dialog_arrow');
        //     if(_arrow.hasClass('arrow_br')){
        //         _arrow.removeClass('arrow_br').addClass('arrow_tr');
        //     }else if(_arrow.hasClass('arrow_bl')){
        //         _arrow.removeClass('arrow_bl').addClass('arrow_tl');
        //     }
        // }

        var _u = xue.win('userinfo');
        // 窗体尺寸
        var w = _u._size.wins();
        
        // handle尺寸
        var h = _u._size.handle();

        // 弹窗的尺寸
        var d = _u._size.box();

        // 设置箭头类别
        // var c = (h.c < w.c) ? 'l' : 'r',        // 垂直区域
        //     m = ((s.t - d.h )< w.s) ? 't' : 'b';            // 水平区域
        //     // m = (h.t < w.m) ? 't' : 'b';            // 水平区域

        var left = (h.c < w.c) ? h.l - (d.w * 0.2) + (h.w / 2) - 7 : (h.l - d.w) + (d.w * 0.2) + (h.w / 2) - 7;

        var new_top = ((h.t - d.h ) < w.s) ? h.t + h.h + 7 : h.t - d.h - 7;

        xue.win('userinfo').position(left, new_top);




        // 当滑出后，点击关注，或者取消按钮时，情况已经缓存到页面中的内容，重新请求
        $('.dialog_userinfo').on('mousedown', '.ui_follow', function(){
            var temp = handle.find('.pop_userinfo_temp');
            if(temp.length > 0){ temp.remove(); }
        });


        if(xue.isIE6){
            $('.dialog_userinfo').find('.dialog_arrow').width($('.dialog_userinfo').width());
            
        }




        // 设置u.opt
        
        // append节点到handle里面
        
        // 执行弹窗


    };

    /**
     * 在鼠标滑过的节点内存入弹出的结构，下次再滑过时不再请求
     * @return {[type]} [description]
     */
    u.setDom = function(handle, content){
        var box = $(handle);
        if(box.length == 0){ return; }

        if(box.find('.pop_userinfo_temp').length == 0){
            box.append('<div class="pop_userinfo_temp">' + content + '</div>')
        }else{
            box.find('.pop_userinfo_temp').html(content);
        }
    };


    u.close = function(){
        $('.dialog_userinfo').hide();
    };


    /**
     * 根据鼠标滑过的节点位置，返回将要显示的弹层坐标
     * @return {[type]} [description]
     */
    u.getPosition = function(){
        var box = u.opt.handle;
        if(!box){ return this; }


    };

    /**
     * 根据鼠标滑过的节点，返回箭头的方向: bl, br, tl, tr
     * @return {[type]} [description]
     */
    u.getOrientation = function(){};

})();