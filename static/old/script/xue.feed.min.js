/**
 * XESUI 
 * Copyright 2013 xueersi.com All rights reserved.
 *
 * @description 
 *
 * @author Marco (marco@xesui.com)
 * @modify 2013-07-08 16:47:25
 * @version $Id$
 * 
 * @links http://xesui.com
 */


/**
 * @name ui.feed.js
 * @description 这里是动态的全部交互
 * 
 * @module 
 * @submodule 
 * @main 
 * @class 
 * @constructor 
 * @static 
 */

xue.feed = xue.feed || {};

(function(){
    var f = xue.feed;

    // 发布动态 -------------------------------------------- //
    
    f.post = f.post || {};

    f.post.submit = function( form ){
        var wrap = $(form), that = this;
        if(wrap.length == 0){ return; }

        that.box = {
            conbox  : wrap.find('.comment_textarea'),
            textarea: wrap.find('.comment_textarea textarea'),
            imgpath : wrap.find('.comment_files'),
            size    : wrap.find('.comment_size'),
            tips    : wrap.find('.comment_tips'),
            submit  : wrap.find('.btn_submit')
        };


        var content = $.trim(that.box.textarea.val());
        var len = content.length;
        if(len < 10 || len > 140 || len == 0){
            this.box.tips.css('display','block');
            this.box.tips.text('请填写内容，长度在10~140之间');
        }else{
            this.box.tips.empty();
            wrap.submit();
        }




    };


    f.post.imgView = function(){};

    f.post.upload = function(){};


    f.upload = f.upload || {};
    /**
     * 上传图片预览
     *
     * 直接将file表单设置为全透明，放到图标的上面
     * @param  {[type]} expr 上传图片的按钮
     * @return {[type]}      [description]
     */
    f.upload.chooseFile = function( expr ){
        var btn = $('.kind_img'), that = this;
        $('.comment_preview').hide();

        if(btn.length === 0){ return; }

        var win_l = Math.floor(btn.offset().left - 3),
            win_t = Math.floor(btn.offset().top + 25);

        xue.win('comment_preview').close();

        if (!/\.(gif|jpg|jpeg|png|GIF|JPG|PNG)$/.test(expr.value)) {
            xue.alert('图片格式无效！');
            return false;
        }
        that.win(win_l, win_t);
        $('.comment_preview').find('img').attr('src', 'http://img04.xesimg.com/loading.gif');

        setImagePreview('comment_files', 'preview_img', 'comment_preview');
    };

    f.upload.win = function(left, top){
        var o = {
            id      : 'comment_preview',
            cls     : 'img_preview',
            title   : '上传图片',
            submit  : false,
            cancel  : false,
            lock    : false,
            close   : function(){
                $('.comment_files, .upload_files').val('');
                xue.win('comment_preview').close();
            },
            left    : left,
            top     : top,
            arrow   : 'tl',
            content : '<div id="comment_preview" class="comment_preview"><img id="preview_img" src="http://img04.xesimg.com/loading.gif" /></div>'
        };
       
        var win = xue.dialog;
        return win(o);
    };


    // 动态里面的媒体 --------------------------------------- //
    
    f.media = f.media || {};

    // 为多种媒体预留：图片、视频等
    f.media.toggle = function( expr ){
        var dom = $(expr);
        if( dom.length === 0 ){ return; }

        var tp = dom.data('type');
        if(tp == 'img'){
            f.img.toggle(expr);
        }
    };

    f.img = f.img || {};

    f.img.box = {
        list : '.feed_media_list',
        extend: 'feed_media_expand'
    };

    f.img.url = {
        small : null,
        large : null
    };

    f.img.toggle = function( expr ){
        var img = $(expr);
        if( img.length === 0 ){ return; }
        var url = img.find('img').attr('src');

        var box = img.parents('.feed_media'),
            other = box.siblings('.feed_media');

        if( box.hasClass('feed_media_list') ){
            this.box.list = box;
            this.box.extend = other;
            this.url.small = url;
            this.url.large = url.replace('_small', '_big');
            this.show();
        }else if( box.hasClass('feed_media_expand')){
            this.box.extend = box;
            this.box.list = other;
            this.url.large = url;
            this.url.small = url.replace('_big', '_small');
            this.hide();
        }

        // this.box.list = box.hasClass('feed_media_list') ? box : box.siblings('.feed_media');
        // this.box.extend = box.hasClass('feed_media_expand') ? box : box.siblings('.feed_media');



    };

    f.img.show = function(){
        if(this.box.list.length === 0 || !this.url.large){ return; }

        // 需要增加loading状态
        
        this.box.list.addClass('hidden').hide();
        if(this.box.extend.find('img').length === 0){
            this.append();
        }
        this.box.extend.removeClass('hidden').show();
    };

    f.img.hide = function(){
        if(this.box.list.length === 0 || !this.url.large){ return; }
        this.box.list.removeClass('hidden').show();
        this.box.extend.addClass('hidden').hide();

    };

    f.img.append = function(){
        // var tpl ='<div class="media_expand_func hidden">功能</div>\n';
        var tpl ='<div class="media_expand_box media_item">\n<p><img src="' + this.url.large + '"></p>\n</div>';
        this.box.extend.html(tpl);
    };


})();

xue.feed.extend = xue.feed.extend || {};
// 动态扩展功能
(function(){
    var fx = xue.feed.extend;
    // 动态试题：切换
    fx.answerToggle = function(d){
        var that = $(d);
        if($(e.target).data('type') == 'radio'){
            return false;
        }else{
            that.hide().siblings('.extend_item').show();
        }
    };
    // 动态试题：提交答案
    fx.answerSubmit = function(d){
        var that = $(d),
            wrap = that.parents('.extend_img_big'),
            box = that.parent().parent(),
            small = box.parent().prev('.extend_img_small');

        if(that.hasClass('submited')){
            xue.alert('此题已做过');
            return false;
        }else{
            that.addClass('submited').siblings('a').addClass('submited');
        }

        var url = window.location.pathname;
        var tpl = '<div class="big_analysis">$analysis$</div>',
            gold = '<div class="Extend_add_gold" style="bottom:100px;opacity:1;"><p><strong>1</strong></p></div>',
            box_html='';

        $.ajax('/Dynamics/ajaxSaveDynQueLog/', {
            type : 'post',
            dataType : 'json',
            data : {
                url : url,
                dynId : that.parents('.feed_detail').data('id'),
                stuAnswer : $.trim(that.text())
            },
            success : function(v){
                var val = xue.ajaxCheck.json(v);
                if(val){
                    // 增加解析内容
                    if(val.analysisimg_path != ''){
                        tpl = tpl.replace('$analysis$', '<strong>解析</strong><img width="720" src="' + val.analysisimg_path + '">');
                    }else{
                        tpl = tpl.replace('$analysis$', '');
                    }
                    box.after(tpl);
                    // 增加右上角正确/错误提示
                    if(val.is_right == '1'){
                        if(val.is_gold == '1'){
                            box.before('<div class="big_mascot r-yes sign-remove"></div>');
                        }else{
                            box.before('<div class="big_mascot r-no sign-remove"></div>');
                        }
                        box.after('<span class="ExtendShow ExtendRight "></span>');
                        small.append('<span class="ExtendShow ExtendRight_small"></span>');
                        //每日五题
                        fx.fiveQuestion(val);
          
                    }else{
                        box.before('<div class="big_mascot w-no sign-remove"></div>');
                        box.after('<span class="ExtendShow ExtendError"></span>');
                        small.append('<span class="ExtendShow ExtendError_small"></span>');
                    }

                    // 修改作答结果
                    //box.html('您的答案是：<strong>' + val.stu_answer + '</strong>　参考答案是：<span>' + val.right_answer + '</span>');
                    if(val.right_num <= 5){
                        //box.html('您的答案是：<strong>' + val.stu_answer + '</strong>　参考答案是：<span>' + val.right_answer + '</span><span class="gray_tip">每日五题已答对<span class="red_tip">'+val.red_num+'</span>题</span>');
                        box_html = '您的答案是：<strong>'
                                 + val.stu_answer
                                 +'</strong>　参考答案是：<span>'
                                 + val.right_answer
                                 +'</span><span class="gray_tip sign-remove">每日五题已答对<span class="red_tip">'
                                 + val.right_num
                                 +'</span>题</span><span class="gray_tip sign-remove">你是第<span class="red_tip">'
                                 +val.dyn_que_replynum
                                 +'</span>个答题的学员，已有<span class="red_tip">'
                                 +val.dyn_que_rightnum
                                 +'</span>人答对!</span>';
                    }else{
                         box_html = '您的答案是：<strong>'
                                 + val.stu_answer
                                 +'</strong>　参考答案是：<span>'
                                 + val.right_answer
                                 +'</span><span class="gray_tip sign-remove">每日五题已完成</span><span class="gray_tip sign-remove">你是第<span class="red_tip">'
                                 +val.dyn_que_replynum
                                 +'</span>个答题的学员，已有<span class="red_tip">'
                                 +val.dyn_que_rightnum
                                 +'</span>人答对!</span>';
                    }
                        box.html(box_html);
                    // 加金币
                    
                    /*if(val.is_gold == '1'){
                        wrap.append(gold);
                        wrap.find('.Extend_add_gold').stop().animate({
                            opacity : 1,
                            bottom : (wrap.height() / 2) - 42
                        }, 'slow', function(){
                            setTimeout(function(){
                                wrap.find('.Extend_add_gold').fadeOut('normal');
                                //console.log('高度='+((wrap.height()/2)-42));
                                //console.log('金币高度='+wrap.find('.Extend_add_gold').css('bottom'));
                            }, 2000);
                        });
                            setTimeout(function(){
                                wrap.find('.Extend_add_gold').fadeOut('normal');
                            },2000);
                    }*/
                }
            }
        });
    };
    // 每日五题：做题时改变数字和领取奖励判断
    fx.fiveQuestion = function(d){
        var box = $('.task_con');

        if(box.find('.task_finish').length > 0){
            return false;
        }

        if(!d){
            return false;
        }
        var num = d.right_num;
        num = (num <= 0) ? 0 : num;

        if(num >= 5){
            box.html('<a href="javascript:void(0);" class="task_days_btn">领取奖励</a>');
            $('.task_five').data('right_num', 5);
        }else{
            box.find('.task_days').text(5 - num);
            $('.task_five').data('right_num', num);
        }
    };
    // 每日五题：提交领取
    fx.fiveQuestionSubmit = function(d){
        var btn = $(d), _con = '', box = null;
        if(btn.length === 0){ return false; }

        function tipsGoldShow(){
                box = btn.parents('.task_con');
                box.html('<span class="task_finish">5</span><p style="color:#6c6c6c;">已领取</p>');
                box.parents('.task_five').data('status',1);
                box.addClass('finish_ed');


                var wrap = $('#container'),
                gold = '<div class="tips_add_gold"><p><strong>5</strong></p></div>';

                wrap.append(gold);
                $('.tips_add_gold').css({
                    left : box.offset().left - 25,
                    top : box.offset().top
                });
                wrap.find('.tips_add_gold').stop().animate({
                    opacity : 1,
                    top : '-='+(box.outerHeight(true)+42)
                }, '1000', function(){
                    setTimeout(function(){
                        wrap.find('.tips_add_gold').fadeOut('100');
                    }, 500);
                });
        }

        $.ajax('/Dynamics/ajaxSaveFiveReceive/', {
            type : 'post',
            dataType : 'json',
            success : function(result){
                var val = xue.ajaxCheck.json(result), box = null;
                if(val){
                    tipsGoldShow();
                }
            }
        });
    };

    // 每日五题：鼠标划过的提示信息
    fx.fiveQuestionTips = function(dom){
        var _box = $(dom),
            _wrap = _box.parents('.task_five'),
            _right= _wrap.data('right_num'),
            _status = _wrap.data('status');
        var _con = '';
        if(_right >= 5 && _status == 1){
            _con = '<p>每日五题任务完成已领取</p>';
        }else{
            _con = '<p>每天答对新鲜事中的 <strong>5</strong> 道题，</p><p>即可获得 <strong>5</strong> 枚金币奖励！</p>';
        }

        xue.win({
            id: 'signTips_five',
            cls: 'signTips',
            title: false,
            cancel: false,
            submit: false,
            arrow: 'tc',
            close: false,
            lock: false,
            follow: _box,
            // time: 2500,
            content: _con
        });
        var _tips = $('#xuebox_signTips_five');
        _tips.css({
            'position': 'absolute'
        });

        // 设置弹窗定位
        xue.win('signTips_five').position(_wrap.offset().left + (_wrap.width() / 2) - (_tips.width() / 2), _wrap.offset().top + _wrap.height() + 10);
        var tipsOut = setTimeout(function(){
            _tips.fadeOut(100,function(){
                xue.win('signTips_five').close();
                tipsOut = null;
            });
        }, 2000);
    };
    // 每日五题：功能提示效果
    fx.fiveQuestionWinTips = function(dom){
        var that = $(dom);
        // if(that.find('.btn_task').length > 0 || that.find('span.finish').length > 0){ return false; }
        xue.win({
            id : 'fiveQuestions',
            title : false,
            cancel : false,
            submitVal : '去做题',
            padding : '10px 10px 0 10px',
            content : '<img src="http://img04.xesimg.com/tips_five.jpg" />',
            submit : function(){
               window.location.href = '/LearningCenter/dynamic/20/';
            }
        });
    };

})();


function getFullPath(obj) {
    if (obj) {
        //ie
        if (window.navigator.userAgent.indexOf("MSIE") >= 1) {
            obj.select();
            var imgSrc = document.selection.createRange().text;
            setImg(imgSrc);
            return imgSrc;
        }
        //firefox
        else {
            if (obj.files) {
                setImg(window.URL.createObjectURL(obj.files.item(0)));
                return window.URL.createObjectURL(obj.files.item(0));
            }
            setImg(obj.value);
            return obj.value;
        }
        setImg(obj.value);
        return obj.value;
    }
}

function setImg(url, dom) {
    var strSrc = url || $(".upload_files").val();
    var pos = strSrc.lastIndexOf(".");
    var lastname = strSrc.substring(pos, strSrc.length);
    if (lastname.toLowerCase() != ".jpg" && lastname.toLowerCase() != ".gif" && lastname.toLowerCase() != ".png") {
        alert("您选择的文件类型为" + lastname + "，图片必须为 JPG,GIF,PNG 类型");
        return false;
    }

    var box = dom ? $(dom) : $('.view_img');
    if( box.length === 0){ return; }

    var img = $('<img class="img_view" />');
    img.attr('src', strSrc);
    var img_view = box.find('.img_view');

    if(img_view.length === 0){
        box.append(img);
    }else{
        img_view.attr('src', strSrc);
    }
    // $('#imgs, .big_pic img, .small_pic img').attr('src', strSrc);
}


function setImagePreview(fileObj, previewObj, localImg) {
    var docObj = document.getElementById(fileObj);
    var imgObjPreview = document.getElementById(previewObj);

    if (docObj.files && docObj.files[0]) {
        //火狐下，直接设img属性
        //火狐7以上版本不能用上面的getAsDataURL()方式获取，需要一下方式  
        imgObjPreview.src = window.URL.createObjectURL(docObj.files[0]);
    } else {
        //IE下，使用滤镜
        docObj.select();
        var imgSrc = document.selection.createRange().text;
        var localImagId = document.getElementById(localImg);
        //必须设置初始大小
        // localImagId.style.width = "120px";
        // localImagId.style.height = "80px";
        //图片异常的捕捉，防止用户修改后缀来伪造图片
        try {
            localImagId.style.filter = "progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod=scale)";
            localImagId.filters.item("DXImageTransform.Microsoft.AlphaImageLoader").src = imgSrc;
        } catch (e) {
            alert("您上传的图片格式不正确，请重新选择!");
            return false;
        }
        imgObjPreview.style.display = 'none';
        document.selection.empty();
    }
    return true;
}